<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="app.title">WeTreat Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- i18n libs -->
  <script src="https://unpkg.com/i18next@23.11.5/dist/umd/i18next.min.js"></script>
  <script src="https://unpkg.com/i18next-browser-languagedetector@7.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
  <script src="https://unpkg.com/i18next-http-backend@2.7.1/i18nextHttpBackend.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
    .status-submitted_by_patient { background-color: #f59e0b; color: white; }
    .status-assigned { background-color: #d97706; color: white; }
    .status-closed { background-color: #6b7280; color: white; }
    .status-report_complete { background-color: #2563eb; color: white; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .modal-content { max-height: 90vh; overflow-y: auto; }
    .lang-switch { position: fixed; top: 1rem; right: 1rem; display:flex; gap:.5rem; z-index:60 }
    .lang-switch button{ padding:.35rem .6rem; border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; cursor:pointer; font-weight:600 }
    .lang-switch button.active{ border-color:#111827 }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <!-- Language Switcher -->
  <nav class="lang-switch" aria-label="Language switcher">
    <button data-lang="de">DE</button>
    <button data-lang="en" class="active">EN</button>
    <button data-lang="fr">FR</button>
    <button data-lang="ro">RO</button>
  </nav>

  <div id="app" class="w-full max-w-3xl mx-auto"></div>
  <div id="modal-container"></div>

  <!-- Tiny helper to apply translations -->
  <script>
    window.applyTranslations = function applyTranslations(){
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const html = el.getAttribute('data-i18n-html') === 'true';
        const val = i18next.t(key);
        if(html){ el.innerHTML = val; } else { el.textContent = val; }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        el.setAttribute('placeholder', i18next.t(key));
      });
      const titleEl = document.querySelector('title[data-i18n]');
      if(titleEl){ titleEl.textContent = i18next.t(titleEl.getAttribute('data-i18n')); }
      document.documentElement.lang = i18next.language || 'en';
    };
  </script>

  <script>
    // --- CONFIG / STATE ---
    const API_URL = 'https://wetreat-22-go-production.up.railway.app';
    const LOCALES_BASE = '/locales';
    let currentUser = null, allEMRs = [], allDoctors = [], currentEMRId = null, currentEMR = null, currentDoctorId = null;
    const app = document.getElementById('app');
    const modalContainer = document.getElementById('modal-container');

    // i18n init
    i18next
      .use(i18nextHttpBackend)
      .use(i18nextBrowserLanguageDetector)
      .init({
        fallbackLng: 'en',
        supportedLngs: ['de','en','fr','ro'],
        backend: { loadPath: `${LOCALES_BASE}/{{lng}}/common.json` },
        detection: { order: ['localStorage','querystring','navigator','htmlTag'], caches: ['localStorage'], lookupQuerystring: 'lng' }
      }, function(){
        initializeApp();
      });

    // switcher
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.lang-switch [data-lang]');
      if(!btn) return;
      const lng = btn.getAttribute('data-lang');
      await i18next.changeLanguage(lng);
      localStorage.setItem('i18nextLng', lng);
      document.querySelectorAll('.lang-switch button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      window.applyTranslations();
    });

    // --- HELPERS ---
    function ensureArray(val){ if(!val) return []; if(Array.isArray(val)) return val; if(typeof val==='string'){ try{const p=JSON.parse(val); return Array.isArray(p)?p:[];}catch{return []} } return []; }
    function isCompleteStatus(s){ return ['report_complete','closed','finalized','complete','completed'].includes((s||'').toLowerCase()); }
    function t(key, def=''){ const v = i18next.t(key); return v===key? def||key : v; }

    // --- VIEWS ---
    const templates = {
      welcome: `
        <div class="bg-white p-8 rounded-xl shadow-lg text-center">
          <img src="https://i.postimg.cc/Sx9NFnRf/wt-logonew-whitecanvas.png" alt="WeTreat Logo" class="mx-auto w-32 h-32 rounded-full mb-6 object-cover">
          <h1 class="text-3xl font-bold text-gray-800" data-i18n="welcome.title">Welcome to WeTreat</h1>
          <p class="text-gray-600 mt-2 mb-8" data-i18n="welcome.tagline">Your trusted online medical consultation platform.</p>
          <div class="space-y-4">
            <h2 class="text-lg font-semibold text-gray-700" data-i18n="welcome.select_role">Please select your role:</h2>
            <div class="flex flex-col sm:flex-row gap-4">
              <button onclick="renderView('patientForm')" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700" data-i18n="roles.patient">Patient</button>
              <button onclick="renderView('login')" class="w-full bg-orange-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-orange-700" data-i18n="roles.doctor">Consulting Physician</button>
              <button onclick="renderView('login')" class="w-full bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-gray-700" data-i18n="roles.admin">Admin</button>
            </div>
          </div>
        </div>`,
      login: `
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
          <img src="https://i.postimg.cc/Sx9NFnRf/wt-logonew-whitecanvas.png" alt="WeTreat Logo" class="mx-auto w-24 h-24 rounded-full mb-4 object-cover">
          <h2 class="text-2xl font-bold text-center text-gray-800 mb-6" data-i18n="login.title">Portal Login</h2>
          <form id="login-form" class="space-y-4">
            <div>
              <label for="email" class="block text-sm font-medium" data-i18n="form.email.label">Email</label>
              <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.email.placeholder">
            </div>
            <div>
              <label for="password" class="block text-sm font-medium" data-i18n="form.password.label">Password</label>
              <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.password.placeholder">
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 border rounded-md text-white bg-gray-700 hover:bg-gray-800" data-i18n="login.submit">Login</button>
          </form>
          <div id="login-error" class="hidden mt-4 text-center text-sm text-red-600"></div>
          <button onclick="renderView('welcome')" class="mt-6 w-full text-center text-blue-600 hover:underline text-sm" data-i18n="nav.back">&larr; Back</button>
        </div>`,
      adminDashboard: `
        <div class="bg-white p-8 rounded-xl shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
              <img src="https://i.postimg.cc/Sx9NFnRf/wt-logonew-whitecanvas.png" alt="WeTreat Logo" class="w-12 h-12 rounded-full object-cover">
              <h2 class="text-2xl font-bold text-gray-800" data-i18n="admin.title">Admin Dashboard</h2>
            </div>
            <div class="flex space-x-4">
              <button onclick="renderView('manageDoctors')" class="text-sm font-semibold text-indigo-600 hover:text-indigo-800" data-i18n="admin.manage_doctors">Manage Doctors</button>
              <button onclick="logout()" class="text-sm font-semibold text-red-600 hover:text-red-800" data-i18n="auth.logout">Logout</button>
            </div>
          </div>
          <div id="emr-list-container" class="space-y-4"></div>
        </div>`,
      doctorDashboard: `
        <div class="bg-white p-8 rounded-xl shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-4">
              <img src="https://i.postimg.cc/Sx9NFnRf/wt-logonew-whitecanvas.png" alt="WeTreat Logo" class="w-12 h-12 rounded-full object-cover">
              <h2 class="text-2xl font-bold text-gray-800" data-i18n="doctor.title">Assigned Consultations</h2>
            </div>
            <button onclick="logout()" class="text-sm font-semibold text-red-600 hover:text-red-800" data-i18n="auth.logout">Logout</button>
          </div>
          <div id="doctor-emr-list-container" class="space-y-4"></div>
        </div>`
    };

    // --- RENDER & NAV ---
    function renderView(viewName){
      app.innerHTML = templates[viewName] || '<p>Loading...</p>';
      window.applyTranslations();
      const post = {
        login: () => document.getElementById('login-form').addEventListener('submit', handleLogin),
        patientForm: renderPatientForm,
        adminDashboard: fetchAndDisplayAdminEMRs,
        doctorDashboard: fetchAndDisplayDoctorEMRs,
        manageDoctors: renderManageDoctors
      };
      if(post[viewName]) post[viewName]();
    }

    // --- PATIENT FORM ---
    function renderPatientForm(){
      const view = `
        <div class="bg-white p-8 rounded-xl shadow-lg">
          <img src="https://i.postimg.cc/Sx9NFnRf/wt-logonew-whitecanvas.png" alt="WeTreat Logo" class="mx-auto w-24 h-24 rounded-full mb-4 object-cover">
          <h2 class="text-2xl font-bold text-center text-gray-800 mb-4" data-i18n="patient.new_request">New Consultation Request</h2>
          <div class="text-right mt-4">
            <button onclick="openPatientInstructionsModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700" data-i18n="patient.instructions_btn">Instructions / Read Me</button>
          </div>
          <form id="patient-form" class="space-y-6"></form>
          <div id="patient-form-message" class="hidden mt-4 text-center text-sm"></div>
          <button onclick="renderView('welcome')" class="mt-6 w-full text-center text-blue-600 hover:underline text-sm" data-i18n="nav.back_welcome">&larr; Back to Welcome</button>
        </div>`;
      app.innerHTML = view;
      window.applyTranslations();

      const form = document.getElementById('patient-form');
      form.innerHTML = `
        <fieldset class="border p-4 rounded-md">
          <legend class="text-lg font-semibold px-2" data-i18n="sections.account">Account</legend>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium" data-i18n="form.email.label">Email</label>
              <input type="email" name="email" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.email.placeholder">
            </div>
            <div>
              <label class="block text-sm font-medium" data-i18n="form.password.label">Password</label>
              <input type="password" name="password" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.password.placeholder">
            </div>
          </div>
        </fieldset>
        <fieldset class="border p-4 rounded-md">
          <legend class="text-lg font-semibold px-2" data-i18n="sections.personal">Personal Data</legend>
          <div>
            <label class="block text-sm font-medium" data-i18n="form.fullname.label">Full Name</label>
            <input type="text" name="name" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.fullname.placeholder">
          </div>
          <div>
            <label class="block text-sm font-medium" data-i18n="form.dob.label">Date of Birth</label>
            <input type="date" name="dob" class="mt-1 block w-full px-3 py-2 border rounded-md">
          </div>
        </fieldset>
        <fieldset class="border p-4 rounded-md">
          <legend class="text-lg font-semibold px-2" data-i18n="sections.medical">Medical Data</legend>
          <div>
            <label class="block text-sm font-medium" data-i18n="form.symptoms.label">Symptoms</label>
            <textarea name="symptoms" rows="3" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.symptoms.placeholder"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium" data-i18n="form.history.label">Medical History</label>
            <textarea name="medicalHistory" rows="3" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.history.placeholder"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium" data-i18n="form.medication.label">Current Medication</label>
            <textarea name="medication" rows="2" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.medication.placeholder"></textarea>
          </div>
          <div class="pt-4">
            <h4 class="text-md font-semibold text-gray-700" data-i18n="form.documents.title">Medical Documents & Imaging</h4>
            <div id="medical-documents-container" class="space-y-2 mt-2"></div>
            <button type="button" onclick="addDocumentRow()" class="text-sm text-blue-600 hover:underline mt-2" data-i18n="form.documents.add">+ Add Document</button>
          </div>
        </fieldset>
        <fieldset class="border p-4 rounded-md">
          <legend class="text-lg font-semibold px-2" data-i18n="sections.doctors">Consulting Physicians</legend>
          <div id="doctor-profiles-container" class="my-2 p-2 border rounded-md max-h-60 overflow-y-auto space-y-3"></div>
          <div>
            <label class="block text-sm font-medium" data-i18n="form.notes.label">Notes</label>
            <textarea name="notes" rows="2" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.notes.placeholder"></textarea>
          </div>
        </fieldset>
        <button type="submit" class="w-full flex justify-center py-3 px-4 mt-4 border rounded-md text-white bg-blue-600 hover:bg-blue-700" data-i18n="form.submit">Submit for Review</button>
      `;
      window.applyTranslations();
      form.addEventListener('submit', handlePatientFormSubmit);
      renderDoctorProfilesForPatient();
      addDocumentRow();
    }

    function addDocumentRow(){
      const container = document.getElementById('medical-documents-container');
      const row = document.createElement('div');
      row.className = 'grid grid-cols-1 md:grid-cols-3 gap-2 items-center';
      row.innerHTML = `
        <input type="text" class="md:col-span-2 px-2 py-1 border rounded-md" name="doc_url" data-i18n-placeholder="form.documents.url_ph">
        <input type="text" class="px-2 py-1 border rounded-md" name="doc_name" data-i18n-placeholder="form.documents.desc_ph">
        <input type="text" class="px-2 py-1 border rounded-md" name="doc_password" data-i18n-placeholder="form.documents.pw_ph">`;
      container.appendChild(row);
      window.applyTranslations();
    }

    function renderDoctorProfilesForPatient(){
      const container = document.getElementById('doctor-profiles-container');
      if(allDoctors.length===0){ container.innerHTML = `<p class="text-gray-500 text-sm" data-i18n="doctors.none">No doctors available.</p>`; window.applyTranslations(); return; }
      container.innerHTML = allDoctors.map(doc => `
        <div class="p-3 border rounded-lg bg-gray-50">
          <div class="flex items-center space-x-3">
            <img src="${doc.photo_url || 'https://placehold.co/48x48/E2E8F0/4A5568?text=Doc'}" class="w-12 h-12 rounded-full object-cover">
            <div>
              <p class="font-bold">${doc.full_name}</p>
              <p class="text-sm text-gray-600">${doc.specialty || t('generic.general_practice','General Practice')}</p>
            </div>
          </div>
          <div class="text-xs text-gray-500 mt-2">
            <p><b data-i18n="doctors.expertise">Expertise:</b> ${doc.expertise_area || 'N/A'}</p>
            <p><b data-i18n="doctors.affiliation">Affiliation:</b> ${doc.current_affiliation || 'N/A'}</p>
          </div>
        </div>`).join('');
      window.applyTranslations();
    }

    // --- ADMIN: MANAGE DOCTORS ---
    function renderManageDoctors(){
      app.innerHTML = `
        <div class="bg-white p-8 rounded-xl shadow-lg">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800" data-i18n="admin.manage_doctors">Manage Doctors</h2>
            <button onclick="renderView('adminDashboard', true)" class="text-sm font-semibold text-blue-600 hover:text-blue-800" data-i18n="nav.back">&larr; Back</button>
          </div>
          <div id="doctor-list-container" class="space-y-2 mb-6"></div>
          <div class="mt-6 pt-6 border-t">
            <h3 class="text-lg font-semibold text-gray-700 mb-4" data-i18n="admin.create_doctor">Create New Doctor</h3>
            <form id="create-doctor-form" class="space-y-4"></form>
            <div id="create-doctor-message" class="hidden mt-4 text-center text-sm"></div>
          </div>
        </div>`;
      window.applyTranslations();
      const form = document.getElementById('create-doctor-form');
      form.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium" data-i18n="form.fullname.label">Full Name*</label><input type="text" name="fullName" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.fullname.placeholder"></div>
          <div><label class="block text-sm font-medium" data-i18n="form.email.label">Email*</label><input type="email" name="email" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.email.placeholder"></div>
          <div><label class="block text-sm font-medium" data-i18n="form.password.label">Password*</label><input type="password" name="password" required class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.password.placeholder"></div>
          <div><label class="block text-sm font-medium" data-i18n="form.photo.label">Photo URL</label><input type="text" name="photoUrl" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.photo.placeholder"></div>
          <div><label class="block text-sm font-medium" data-i18n="form.specialty.label">Specialty</label><input type="text" name="specialty" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.specialty.placeholder"></div>
          <div><label class="block text-sm font-medium" data-i18n="form.expertise.label">Area of Expertise</label><input type="text" name="expertiseArea" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.expertise.placeholder"></div>
          <div><label class="block text-sm font-medium" data-i18n="form.affiliation.label">Current Affiliation</label><input type="text" name="currentAffiliation" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.affiliation.placeholder"></div>
          <div><label class="block text-sm font-medium" data-i18n="form.linkedin.label">LinkedIn Profile</label><input type="text" name="linkedinUrl" class="mt-1 block w-full px-3 py-2 border rounded-md" data-i18n-placeholder="form.linkedin.placeholder"></div>
        </div>
        <fieldset class="border p-4 rounded-md">
          <legend class="text-sm font-medium px-1" data-i18n="fees.title">Consultation Fees (€)</legend>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <div><label class="block text-xs" data-i18n="fees.office">Office</label><input type="number" step="0.01" name="feeOffice" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
            <div><label class="block text-xs" data-i18n="fees.home">Home</label><input type="number" step="0.01" name="feeHome" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
            <div><label class="block text-xs" data-i18n="fees.video">Video</label><input type="number" step="0.01" name="feeVideo" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
            <div><label class="block text-xs" data-i18n="fees.phone">Phone</label><input type="number" step="0.01" name="feePhone" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
            <div><label class="block text-xs" data-i18n="fees.review">Review</label><input type="number" step="0.01" name="feeReview" class="mt-1 block w-full px-3 py-2 border rounded-md"></div>
          </div>
        </fieldset>
        <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md text-white bg-green-600 hover:bg-green-700" data-i18n="admin.create_btn">Create Doctor</button>
      `;
      window.applyTranslations();
      form.addEventListener('submit', handleCreateDoctor);
      displayDoctorListForAdmin();
    }

    function displayDoctorListForAdmin(){
      const container = document.getElementById('doctor-list-container');
      container.innerHTML = allDoctors.map(doc => `
        <div class="p-3 border rounded-lg bg-gray-50 flex justify-between items-center">
          <div class="flex items-center space-x-3">
            <img src="${doc.photo_url || 'https://placehold.co/48x48/E2E8F0/4A5568?text=Doc'}" class="w-12 h-12 rounded-full object-cover">
            <div>
              <p class="font-bold">${doc.full_name}</p>
              <p class="text-sm text-gray-600">${doc.specialty || 'N/A'}</p>
            </div>
          </div>
          <div>
            <button onclick="openEditDoctorModal('${doc.user_id}')" class="text-sm text-blue-600 hover:underline" data-i18n="generic.edit">Edit</button>
            <button onclick="handleDeleteDoctor && handleDeleteDoctor('${doc.user_id}')" class="ml-4 text-sm text-red-600 hover:underline" data-i18n="generic.delete">Delete</button>
          </div>
        </div>`).join('');
      window.applyTranslations();
    }

    // Instructions modal (text keys scaffolded; translate JSON later)
    function openPatientInstructionsModal(){
      modalContainer.innerHTML = `
        <div class="modal-overlay" onclick="closePatientInstructionsModal(event)">
          <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-3xl modal-content" onclick="event.stopPropagation()">
            <div class="flex items-start justify-between">
              <h3 class="text-xl md:text-2xl font-bold text-gray-800" data-i18n="instr.title">Instructions for Completing the Consultation Request</h3>
              <button class="ml-4 text-gray-500 hover:text-gray-700" onclick="closePatientInstructionsModal(event)">✕</button>
            </div>
            <div class="mt-4 space-y-4 text-sm md:text-base leading-relaxed text-gray-800">
              <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg"><p class="font-semibold" data-i18n="instr.read_first">Please read carefully before submitting your request.</p></div>
              <h4 class="text-lg font-semibold mt-4" data-i18n="instr.form.h">1) Completing the Form</h4>
              <ul class="list-disc pl-6 space-y-1">
                <li data-i18n="instr.form.li1">Provide accurate personal and medical information.</li>
                <li data-i18n="instr.form.li2">Use clear descriptions for symptoms (onset, triggers, duration).</li>
                <li data-i18n="instr.form.li3">Optionally review physician profiles and add notes.</li>
              </ul>
              <h4 class="text-lg font-semibold mt-4" data-i18n="instr.upload.h">2) Uploading Medical Documents</h4>
              <ul class="list-disc pl-6 space-y-1">
                <li data-i18n="instr.upload.li1"><strong>Allowed:</strong> PDF and hospital PACS / DICOM links.</li>
                <li data-i18n="instr.upload.li2"><strong>Not accepted:</strong> WhatsApp, WeTransfer, email attachments.</li>
                <li data-i18n="instr.upload.li3">WeTreat is view‑only: we do not download or redistribute your files.</li>
              </ul>
              <h4 class="text-lg font-semibold mt-4" data-i18n="instr.onboarding.h">3) Onboarding Process After Submission</h4>
              <ol class="list-decimal pl-6 space-y-1">
                <li data-i18n="instr.onboarding.li1"><strong>Admin review</strong> for completeness and GDPR compliance.</li>
                <li data-i18n="instr.onboarding.li2"><strong>Direct contact</strong> by email or phone.</li>
                <li data-i18n="instr.onboarding.li3"><strong>Payment & consent</strong> required before assignment.</li>
              </ol>
              <h4 class="text-lg font-semibold mt-4" data-i18n="instr.consult.h">4) Consultation and Report</h4>
              <ul class="list-disc pl-6 space-y-1">
                <li data-i18n="instr.consult.li1">Physician completes a medical report.</li>
                <li data-i18n="instr.consult.li2">Report provided as PDF; e‑signature optional.</li>
                <li data-i18n="instr.consult.li3">Admins can forward the report to the patient.</li>
              </ul>
              <h4 class="text-lg font-semibold mt-4" data-i18n="instr.legal.h">5) Responsibilities and Legal Notes</h4>
              <ul class="list-disc pl-6 space-y-1">
                <li data-i18n="instr.legal.li1"><strong>Medical responsibility</strong> lies with the consulting physician.</li>
                <li data-i18n="instr.legal.li2">WeTreat provides a secure (tele)consultation platform only.</li>
                <li data-i18n="instr.legal.li3">Data are processed according to GDPR and EU regulations.</li>
                <li data-i18n="instr.legal.li4">Submitting the form implies consent for data processing.</li>
              </ul>
              <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg"><p class="text-sm" data-i18n="instr.note">If your PDFs are password‑protected, include the password in the Documents section.</p></div>
            </div>
            <div class="mt-6 flex justify-end">
              <button class="px-4 py-2 rounded-md bg-gray-800 text-white hover:bg-gray-900" onclick="closePatientInstructionsModal(event)" data-i18n="generic.understand">I Understand</button>
            </div>
          </div>
        </div>`;
      window.applyTranslations();
    }
    function closePatientInstructionsModal(event){ if(event) event.stopPropagation(); modalContainer.innerHTML=''; }

    function openEditDoctorModal(userId){ /* unchanged body from your version; ensure to call window.applyTranslations() after injecting */ }
    function closeEditDoctorModal(e){ if (e && e.target !== e.currentTarget) return; modalContainer.innerHTML=''; }

    // --- API HELPERS / AUTH / FORMS --- (your original functions, unchanged)
    async function handleApiRequest(url, options, messageDiv){
      try{ const response = await fetch(url, options); const result = await response.json(); if(!response.ok) throw new Error(result.message || 'An error occurred.'); return result; }
      catch(error){ if(messageDiv){ messageDiv.textContent = error.message; messageDiv.className = 'mt-4 text-center text-sm text-red-600'; messageDiv.classList.remove('hidden'); } throw error; }
    }
    async function handleLogin(event){ event.preventDefault(); const form = event.target; const errorDiv = document.getElementById('login-error'); errorDiv.classList.add('hidden'); try{ const data = await handleApiRequest(`${API_URL}/api/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: form.elements.email.value, password: form.elements.password.value }) }, errorDiv); currentUser = data.user; await fetchAllDoctors(); if(currentUser.role==='admin') renderView('adminDashboard'); else if(currentUser.role==='doctor') renderView('doctorDashboard'); } catch(e){ console.error('Login failed'); } }

    // ... keep the rest of your original JS (fetch, EMR views, doctor/admin updates)
    // IMPORTANT: after any `innerHTML = ...`, call window.applyTranslations();

    async function fetchAllDoctors(){ try{ const response = await fetch(`${API_URL}/api/doctors`); if(!response.ok) throw new Error('Could not fetch doctors.'); allDoctors = await response.json(); } catch(e){ console.error(e); allDoctors=[]; } }

    function logout(){ currentUser=null; allEMRs=[]; allDoctors=[]; currentEMRId=null; currentDoctorId=null; initializeApp(); }

    async function initializeApp(){ await fetchAllDoctors(); renderView('welcome'); }
  </script>
</body>
</html>
